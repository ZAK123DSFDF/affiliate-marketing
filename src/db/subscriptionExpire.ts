// scripts/expire-subscription.ts
import "dotenv/config"
import { db } from "@/db/drizzle"
import { subscription } from "@/db/schema"
import { eq } from "drizzle-orm"

const DEV_USER_ID = "29022934-eb52-49af-aca4-b6ed553c89dd"

// ----------------------------- HELPERS -----------------------------

async function getLocalSubscription(userId: string) {
  const sub = await db.query.subscription.findFirst({
    where: eq(subscription.userId, userId),
  })

  if (!sub) throw new Error("âŒ No subscription found for " + userId)

  return sub
}

async function expireSubscription(sub: any) {
  const expiredAt = new Date()
  expiredAt.setDate(expiredAt.getDate() - 1)

  await db
    .update(subscription)
    .set({ expiresAt: expiredAt })
    .where(eq(subscription.id, sub.id))

  return expiredAt
}

// ----------------------------- MAIN -----------------------------

async function main() {
  const userId = process.argv[2] || DEV_USER_ID
  console.log(`â–¶ Using userId: ${userId}`)

  const sub = await getLocalSubscription(userId)

  console.log(`ðŸ” Found subscription: ${sub.id} (${sub.plan})`)

  const date = await expireSubscription(sub)

  console.log(`âœ” Subscription expired at ${date.toISOString()}`)
  console.log("ðŸŽ‰ Done!")
}

main().catch((err) => console.error(err))
